<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Try Squeak</title>
<link rel="icon" type="image/png" href="squeakjs.png">
<link rel="stylesheet" href="try.css">
<script src="squeak.min.js"></script>
<script>
    function runDemo(imageName) {
        SqueakJS.runSqueak("squeakjs.image", sqCanvas, {
            files: ["squeakjs.changes"],
            swapButtons: true,
            header: sqText,
            spinner: sqSpinner,
            appName: "SqueakJS",
        });
    }
    function runSqueak(imageName) {
        sqCanvas.style.position = "absolute";
        sqText.style.display = "none";
        SqueakJS.runSqueak(imageName, sqCanvas, {
            fullscreen: true,
            spinner: sqSpinner,
            appName: imageName && imageName.replace(/\.image$/, ""),
        });
    }
    function exportFile(a) {
        var path = Squeak.splitFilePath(a.innerText);
        Squeak.fileGet(path.fullname, function(buffer) {
            var blob = new Blob([buffer], {type: 'application/octet-stream'}),
                blobURL = URL.createObjectURL(blob);
            a.setAttribute('href', blobURL);
            a.setAttribute('download', path.basename);
            a.onclick = function(){
                setTimeout(function(){URL.revokeObjectURL(blobURL)}, 0);
                return true;
            };
            a.click();
        }, alert);
        return false;
    }
    function showFiles() {
        var imgList = [],
            fileList = [],
            dirs = [''],
            nFiles = nDirs = nBytes = 0;
        while (dirs.length > 0) {
            var dir = dirs.pop(),
                entries = Squeak.dirList(dir);
            for (var f in entries) {
                var entry = entries[f],
                    path = dir + '/' + f;
                if (!dir && !entry[3] && f.match(/\.image$/))
                    imgList.push('<li>Run <a href="#image=' + path + '">' + f + '</a></li>');
                if (entry[3]) {
                    dirs.push(path);
                    nDirs++;
                } else {
                    nFiles++;
                    nBytes += entry[4];
                    fileList.push('<li><a href="squeak:' + path + '" onclick="return exportFile(this)" target="_blank">' + path + '</a>' +
                        (entry[4] >= 100000 ? ' (' + (entry[4]/1000000).toFixed(1) + ' MB)' 
                        : ' (' + (entry[4]/1000).toFixed(1) + ' KB)') + '</li>');
                }
            };
        }
        function fdir(s) { return s.replace(/<[^>]*>/gi,'').replace(/[^\/]*$/, ''); }
        function fsort(a, b) { return fdir(a).localeCompare(fdir(b)) || a.localeCompare(b); }
        if (fileList.length) {
            files.innerHTML = "<ul>" + fileList.sort(fsort).join("") + "</ul>";
            filestats.innerHTML = nFiles + " files in " + nDirs + " directories, " +
                (nBytes/1000000).toFixed(1) + " MBytes total";
        }          
        if (imgList.length) images.innerHTML = "<p>Previously run local images:</p><ul>" + imgList.sort(fsort).join("") + "</ul>";
        else images.innerHTML = "<ul>[Once you have dropped local images to this page they will be listed here.]</ul>"
    }
    window.onhashchange = function() {
        window.location.reload();
    }
    window.onload = function() {
        // if we have an image or zip in hash then we run Squeak with the options provided in the url
        if (location.hash.match(/(\.image(\W|$)|\Wzip=)/)) {
            return runSqueak();
        }
        // otherwise we run the demo ...
	runDemo();
        // ... and generate the text to display
        var links = document.getElementsByTagName("a");
        for (var i = 0; i < links.length; i++) {
            var link = links[i],
                href = link.getAttribute("href");
            if (href[0] === "#" && link.innerHTML === "link") {
                link.innerHTML = href;
                link.onclick = (function(href) {
                    return function onclick() { window.location = href; }
                })(href);
            }
        }
        // show stored files and images. Update after fsck (which takes a while)
        showFiles();
        setTimeout(function() {
            Squeak.fsck(function(stats) { if (stats.deleted) showFiles(); });
        }, 0);
        // also, enable drag-and-drop even if no image loaded yet
        // (squeak.js will replace these when an image is running)
        document.body.ondragover = function(evt) {
            evt.preventDefault();
            if (evt.dataTransfer.items[0].kind == "file") {
                evt.dataTransfer.dropEffect = "copy";
                drop.style.borderColor = "#0E0";
            } else {
                evt.dataTransfer.dropEffect = "none";
            }
            return false;
        };
        document.body.ondragleave = function(evt) {
            drop.style.borderColor = "";
        };
        document.body.ondrop = function(evt) {
            evt.preventDefault();
            drop.style.borderColor = "#080";
            var files = [].slice.call(evt.dataTransfer.files),
                todo = files.length,
                imageName = null;
            files.forEach(function(f) {
                var reader = new FileReader();
                reader.onload = function () {
                    var buffer = this.result;
                    console.log("Storing " + f.name + " (" + buffer.byteLength + " bytes)");
                    if (/.*image$/.test(f.name)) imageName = f.name;
                    Squeak.filePut(f.name, buffer, function success() {
                        if (--todo > 0) return;
                        drop.style.borderColor = "";
                        if (!imageName) showFiles();
                        else runSqueak(imageName);
                    });
                }
                reader.onerror = function() {
                    alert("Failed to read " + f.name); 
                    drop.style.borderColor = "";
                }
                reader.readAsArrayBuffer(f);
            });
            return false;
        };
    }
</script>
</head>
<body>
    <canvas id="sqCanvas" width="800" height="480"></canvas>
    <div id="sqSpinner"><div></div></div>
    <div id="sqText">
        <h1></h1>
	<p>This page gives you a glimpse of <a href="http://squeak.org/" target="_blank">Squeak</a> without installing anything. It is using
        <a href="http://bertfreudenberg.github.io/SqueakJS/" target="_blank">SqueakJS</a>, a Virtual Machine for running Squeak on top of JavaScript.
        Besides running regular Squeak code, SqueakJS also lets you access JavaScript via the <a href="#document=JSBridge.st">JSBridge</a>.</p>

        <p>It currently works best in Chrome, also works in FireFox and IE, but sometimes crashes in Safari.
        It is quite slow compared to <a href="http://www.squeak.org/Downloads" target="_blank">native Squeak</a>,
        because this is executing a Squeak Virtual Machine inside a JavaScript Virtual Machine.</p>

	<p>Above you see a stripped-down version of Squeak 2.2, which was released in 1998. Modern Squeak versions are much more advanced, but more demanding, too.</p>

        <h2>Other Squeak images</h2>
        You can try your own Squeak images by dropping them into this page.
        Or you can construct a URL linking to this page and pass the image and options.
        <em>Beware that the server needs to allow script access via <a href="http://enable-cors.org/server.html" target="_blank">CORS</a>.</em>
        <br>Here are a few examples:
        <ul>
        <li>Squeak 1.13 (1996) <a href="#url=http://freudenbergs.de/bert/squeakjs&files=[Squeak1.13u.image,Squeak1.13u.changes,SqueakV1.sources]&swapButtons=true">link</a></li>
        <li>Squeak 2.8 (2000) <a href="#url=http://freudenbergs.de/bert/squeakjs&files=[Squeak2.8.image,Squeak2.8.changes,SqueakV2.sources]&swapButtons=true">link</a></li>
        <li>Squeak 3.8 (2006) <a href="#url=http://freudenbergs.de/bert/squeakjs&files=[Squeak3.8.1-6747full.image,Squeak3.8.1-6747full.changes,SqueakV3.sources]&swapButtons=true">link</a></li>
        <li>Squeak 3.9 (2008) <a href="#url=http://freudenbergs.de/bert/squeakjs&files=[Squeak3.9.1-final-7075.image,Squeak3.9.1-final-7075.changes,SqueakV39.sources]&swapButtons=true">link</a></li>
        <li>Squeak 4.5 (2014) <a href="#url=http://freudenbergs.de/bert/squeakjs&files=[Squeak4.5-13680.image,Squeak4.5-13680.changes,SqueakV41.sources]">link</a></li>
        <li>Squeak 5.0 (2015) <a href="#url=http://files.squeak.org/5.0/&zip=[Squeak5.0-15113.zip,SqueakV50.sources.zip]">link</a></li>
        </ul>
        On the first run these will be stored locally. Subsequent starts are faster.

	<h2>Run Squeak For Real</h2>
	<a href="http://www.squeak.org/Downloads" target="_blank">Download</a> a high-performance Virtual Machine for Squeak and run it as an app from your desktop.
        Other optimized Virtual Machines are available for iOS and Android mobile devices.

        <h2>Your SqueakJS Files</h2>
        You can use drag-and-drop to run a Squeak image from your machine: drop the image (perhaps together with a changes and sources file) into this page.
        <div id="images"></div>
        All images and related files are stored persistently in a database inside your browser.
        The box below shows the files that are currently in your database.  Inside Squeak, you can use a FileList
        to manage them.
        <div id="drop">Drop Squeak images and other files here.
            <div id="files" class="filelist"></div>
            <div id="filestats"></div>
        </div>
        Clicking on a name in the box will export that file to your browser's downloads folder.
    </div>
</body>
</html>
